<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        canvas { position: absolute; left: 0; top: 0; width: 100vw; height: 100vh; object-fit: cover; }
        video { display: none; }
        #instruction { 
            position: absolute; top: 40px; width: 100%; text-align: center; 
            color: #fff; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000; z-index: 100;
        }
        #feedback {
            position: absolute; top: 80px; width: 100%; text-align: center;
            color: #0f0; font-size: 20px; z-index: 100; display: none;
        }
        #ui { position: absolute; bottom: 20px; width: 100%; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; z-index: 100; padding: 10px; box-sizing: border-box; }
        button { padding: 12px 18px; border-radius: 20px; border: 2px solid #0f0; background: rgba(0,0,0,0.8); color: #0f0; font-weight: bold; }
        button.active { background: #0f0; color: #000; }
    </style>
</head>
<body>
    <div id="instruction">1. 注  注专转 砖转 </div>
    <div id="feedback">注! 驻注 爪注</div>
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>
    <div id="ui">
        <button onclick="setMode('none')" id="btnNone" class="active">专</button>
        <button onclick="setMode('left')" id="btnLeft">砖</button>
        <button onclick="setMode('right')" id="btnRight"></button>
        <button onclick="takeSnapshot()"> 转</button>
    </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const feedback = document.getElementById('feedback');
let mirrorMode = 'none';

async function setup() {
    await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
    await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
    video.srcObject = stream;
    video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        detect();
    };
}

function setMode(mode) {
    mirrorMode = mode;
    document.querySelectorAll('#ui button').forEach(btn => btn.classList.remove('active'));
    document.getElementById('btn' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
}

async function detect() {
    setInterval(async () => {
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (detections.length > 0) {
            const landmarks = detections[0].landmarks;
            
            // 拽 拽转 注:  -AI 转拽砖 转 转 拽 转专 砖  (  住转专转 转)
            //  驻砖专 住祝 砖 专拽  住驻  . 专注  爪 转 转.
            
            const nx = landmarks.getNose()[0].x;
            const vW = video.videoWidth;
            const vH = video.videoHeight;

            if (mirrorMode === 'none') {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            } else if (mirrorMode === 'left') {
                ctx.drawImage(video, 0, 0, nx, vH, 0, 0, nx, vH);
                ctx.save(); ctx.translate(nx * 2, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, nx, vH, 0, 0, nx, vH); ctx.restore();
            } else if (mirrorMode === 'right') {
                const rightPartW = vW - nx;
                ctx.drawImage(video, nx, 0, rightPartW, vH, nx, 0, rightPartW, vH);
                ctx.save(); ctx.translate(nx * 2, 0); ctx.scale(-1, 1);
                ctx.drawImage(video, nx, 0, rightPartW, vH, nx, 0, rightPartW, vH); ctx.restore();
            }
        } else {
            //  驻 注 (砖  砖转  住转 )
            if (mirrorMode !== 'none') feedback.style.display = 'block';
        }
    }, 40);
}

function takeSnapshot() {
    const link = document.createElement('a');
    link.download = 'capture.png';
    link.href = canvas.toDataURL();
    link.click();
}

document.body.addEventListener('click', () => video.play());
setup();
</script>
</body>
</html>
